{% extends 'base.html' %}

{% block title %}Support Queue{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
<li class="breadcrumb-item active">Support Queue</li>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-headset me-2"></i>Support Queue</h2>
    <span class="badge bg-warning fs-6">{{ pending_sessions.count }} Pending</span>
</div>

{% if active_sessions %}
<div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
        <h6 class="mb-0"><i class="bi bi-play-circle me-2"></i>My Active Sessions</h6>
    </div>
    <div class="list-group list-group-flush">
        {% for session in active_sessions %}
        <a href="{% url 'remote_session_room' session.session_code %}" class="list-group-item list-group-item-action">
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">
                    <span class="badge bg-{{ session.get_priority_color }} me-2">{{ session.get_priority_display }}</span>
                    {{ session.subject }}
                </h6>
                <span class="badge bg-{{ session.get_status_color }}">{{ session.get_status_display }}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <small class="text-muted"><i class="bi bi-person me-1"></i>{{ session.requester.get_full_name|default:session.requester.username }}</small>
                <small><i class="bi bi-display me-1"></i>AnyDesk: <strong class="text-primary">{{ session.anydesk_id }}</strong></small>
            </div>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-header bg-warning text-dark">
        <h6 class="mb-0"><i class="bi bi-hourglass-split me-2"></i>Pending Requests</h6>
    </div>
    {% if pending_sessions %}
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Priority</th>
                    <th>Subject</th>
                    <th>Requester</th>
                    <th>AnyDesk ID</th>
                    <th>Waiting Since</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for session in pending_sessions %}
                <tr>
                    <td><span class="badge bg-{{ session.get_priority_color }}">{{ session.get_priority_display }}</span></td>
                    <td>
                        <strong>{{ session.subject|truncatechars:40 }}</strong>
                        <br><small class="text-muted">{{ session.description|truncatechars:60 }}</small>
                    </td>
                    <td><i class="bi bi-person me-1"></i>{{ session.requester.get_full_name|default:session.requester.username }}</td>
                    <td><code class="fs-5 text-primary">{{ session.anydesk_id }}</code></td>
                    <td><span title="{{ session.created_at }}">{{ session.created_at|timesince }} ago</span></td>
                    <td>
                        <form method="post" action="{% url 'accept_session' session.session_code %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-success"><i
                                    class="bi bi-check-lg me-1"></i>Accept & Connect</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="card-body text-center py-5 text-muted">
        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
        No pending support requests
    </div>
    {% endif %}
</div>

<div class="card mt-4">
    <div class="card-header bg-success text-white">
        <h6 class="mb-0"><i class="bi bi-check-circle me-2"></i>Completed Requests (Last 50)</h6>
    </div>
    {% if completed_sessions %}
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Priority</th>
                    <th>Subject</th>
                    <th>Requester</th>
                    <th>Technician</th>
                    <th>Completed At</th>
                </tr>
            </thead>
            <tbody>
                {% for session in completed_sessions %}
                <tr>
                    <td><span class="badge bg-{{ session.get_priority_color }}">{{ session.get_priority_display }}</span></td>
                    <td>
                        <strong>{{ session.subject|truncatechars:40 }}</strong>
                        <br><small class="text-muted">{{ session.description|truncatechars:60 }}</small>
                    </td>
                    <td><i class="bi bi-person me-1"></i>{{ session.requester.get_full_name|default:session.requester.username }}</td>
                    <td><i class="bi bi-headset me-1"></i>{{ session.technician.get_full_name|default:session.technician.username }}</td>
                    <td><span title="{{ session.completed_at }}">{{ session.completed_at|date:"M d, H:i" }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="card-body text-center py-4 text-muted">
        No completed requests found.
    </div>
    {% endif %}
</div>
{% endblock %}